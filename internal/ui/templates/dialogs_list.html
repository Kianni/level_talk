{{ define "dialogs_list.html" }}
{{ if not .Dialogs }}
<p class="muted">{{ t .Lang "no_dialogs" }}</p>
{{ else }}
<div class="download-buttons-inline">
  <button type="button" id="download-text-btn" class="button-link secondary" disabled>{{ t .Lang "download_selected_text" }}</button>
  <button type="button" id="download-audio-btn" class="button-link secondary" disabled>{{ t .Lang "download_selected_audio" }}</button>
</div>
<script>
(function() {
  const basePath = {{ if .BasePath }}{{ printf "%q" .BasePath }}{{ else }}''{{ end }};
  const selectAll = document.getElementById('select-all');
  const checkboxes = document.querySelectorAll('.dialog-checkbox');
  const downloadTextBtn = document.getElementById('download-text-btn');
  const downloadAudioBtn = document.getElementById('download-audio-btn');
  
  function updateDownloadButtons() {
    const selected = Array.from(checkboxes).filter(cb => cb.checked);
    const hasSelection = selected.length > 0;
    downloadTextBtn.disabled = !hasSelection;
    downloadAudioBtn.disabled = !hasSelection;
  }
  
  function updateSelectAll() {
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    const someChecked = Array.from(checkboxes).some(cb => cb.checked);
    selectAll.checked = allChecked;
    selectAll.indeterminate = someChecked && !allChecked;
  }
  
  if (selectAll) {
    selectAll.addEventListener('change', function() {
      checkboxes.forEach(cb => cb.checked = selectAll.checked);
      updateDownloadButtons();
    });
  }
  
  checkboxes.forEach(cb => {
    cb.addEventListener('change', function() {
      updateDownloadButtons();
      updateSelectAll();
    });
  });
  
  downloadTextBtn.addEventListener('click', function() {
    const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
    if (selected.length === 0) return;
    const url = basePath + '/dialogs/download/text?' + selected.map(id => 'id=' + encodeURIComponent(id)).join('&');
    window.location.href = url;
  });
  
  downloadAudioBtn.addEventListener('click', function() {
    const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
    if (selected.length === 0) return;
    const url = basePath + '/dialogs/download/audio?' + selected.map(id => 'id=' + encodeURIComponent(id)).join('&');
    window.location.href = url;
  });
  
  updateDownloadButtons();
  updateSelectAll();
  
  // Handle delete buttons
  document.querySelectorAll('.delete-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const dialogId = this.getAttribute('data-dialog-id');
      const confirmMsg = {{ if .Lang }}{{ printf "%q" (t .Lang "confirm_delete") }}{{ else }}'Are you sure you want to delete this dialog? This action cannot be undone.'{{ end }};
      
      if (!confirm(confirmMsg)) {
        return;
      }
      
      // Get current filter values from the search form
      const searchForm = document.querySelector('form[hx-get*="/dialogs/search"]');
      const formData = new FormData(searchForm || document.createElement('form'));
      const params = new URLSearchParams();
      
      ['input_language', 'dialog_language', 'cefr_level'].forEach(function(key) {
        const value = formData.get(key);
        if (value) {
          params.append(key, value);
        }
      });
      
      const queryString = params.toString();
      const deleteUrl = basePath + '/dialogs/' + dialogId + (queryString ? '?' + queryString : '');
      
      // Use HTMX to delete and refresh the list
      htmx.ajax('DELETE', deleteUrl, {
        target: '#dialog-list',
        swap: 'innerHTML'
      });
    });
  });
})();
</script>
<table class="dialog-table">
  <thead>
    <tr>
      <th><input type="checkbox" id="select-all" title="{{ t .Lang "select_all" }}"></th>
      <th>{{ t .Lang "name" }}</th>
      <th>{{ t .Lang "input" }}</th>
      <th>{{ t .Lang "dialog" }}</th>
      <th>{{ t .Lang "cefr" }}</th>
      <th>{{ t .Lang "created" }}</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {{ range .Dialogs }}
    <tr>
      <td><input type="checkbox" name="dialog_id" value="{{ .ID }}" class="dialog-checkbox"></td>
      <td>{{ dialogName .Title .InputLanguage .DialogLanguage .CEFRLevel .InputWords }}</td>
      <td>{{ .InputLanguage }}</td>
      <td>{{ .DialogLanguage }}</td>
      <td>{{ .CEFRLevel }}</td>
      <td>{{ formatTime .CreatedAt }}</td>
      <td>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <a class="link" href="{{ url $.BasePath "/dialogs/" }}{{ .ID }}">{{ t $.Lang "open" }}</a>
          <button type="button" 
                  class="button-link secondary delete-btn" 
                  data-dialog-id="{{ .ID }}"
                  title="{{ t $.Lang "delete" }}">
            {{ t $.Lang "delete" }}
          </button>
        </div>
      </td>
    </tr>
    {{ end }}
  </tbody>
</table>
{{ end }}
{{ end }}

